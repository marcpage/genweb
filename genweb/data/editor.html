<!DOCTYPE html>
<html lang="en" translate="no" class="notranslate">
	<head>
        <title>genweb editor</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta charset="utf-8"/>
		<meta name="google" content="notraslate"/>
        <style>
            .table_label {
                text-align: right;
                font-weight: bold;
            }
            .editor {
                background-color: azure;
                border-radius: 30px;
                padding: 30px;
                display:inline-block;
            }
            #people_search {
                display: inline-block; /* none */
                background-color:blanchedalmond;
                border-radius: 30px;
                padding: 30px;
                display:inline-block;
            }
        </style>
        <script>
            const MAXIMUM_TYPE_AHEAD = 50;
            var server_state = {people:undefined, metadata:undefined};
            const visible_fields = {
                title:["inline", "href", "picture"],
                path:["inline", "href", "picture"],
                file:["inline", "href", "picture"],
                people:["inline", "href", "picture"],
                mod_date:["inline", "picture", "href"],
                folder:["href"],
                height:["picture"],
                width:["picture"],
                contents:["inline"],
            };
            
            function type_change(selector_id) {
                var selector = document.getElementById(selector_id);
                
                for (const field in visible_fields) {
                    var field_row = document.getElementById(field);

                    if (visible_fields[field].includes(selector.value)) {
                        field_row.style.display = "table-row";
                    } else {
                        field_row.style.display = "none";
                    }
                }
            }
            function reset_select(field, values) {
                var select = document.getElementById(field);
                
                while (select.options.length > 0) {
                    select.remove(select.options.length - 1);
                }

                for (var i = 0; i < values.length; ++i) {
                    var option = document.createElement("option");
                    option.value = values[i];
                    option.innerHTML = values[i];
                    select.appendChild(option);
                }
            }
            function server_state_updated(field, field_id) {
                if (server_state[field]) {
                    reset_select(field_id, server_state[field]);
                }
            }
            function load_into(url, field, field_id) {
                var request = new XMLHttpRequest();
                request.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        server_state[field] = JSON.parse(request.responseText);
                        server_state_updated(field, field_id);
                    }
                }
                request.open("GET", url, true);
                request.send();
            }
            function load_values() {
                load_into("/api/v1/people", "people", "people");
                load_into("/api/v1/metadata", "metadata", "metadata");
            }
            function words_match(words, value) {
                const word_list = words.split(" ").map((x) => x.toLowerCase());;
                const lower_value = value.toLowerCase();
                const matches = word_list.filter((word) => lower_value.includes(word));
                return matches.length == word_list.length;
            }
            function type_ahead(input_id, field) {
                if (server_state[field]) {
                    var input = document.getElementById(input_id);
                    var options = document.getElementById(input_id+"-options");
                    console.log(field);
                    console.log(server_state[field].length);
                    console.log(input);
                    console.log(input.value);
                    const matches = server_state[field].filter(function (i) {
                        return words_match(input.value, i);
                    }).slice(0,MAXIMUM_TYPE_AHEAD);
                    reset_select(input_id+"-options", matches);
                    options.style.display = matches ? "" : "none";
                    options.size = matches.length;
                }
            }
            function blur_type_ahead(input_id, field) {
                var input = document.getElementById(input_id);
                var options = document.getElementById(input_id+"-options");
                setTimeout(() => { 
                    options.style.display="none";
                    if (!server_state[field].includes(input.value)) {
                        input.value = "";
                    }
                }, 400);
            }
            function select_type_ahead(input_id) {
                var input = document.getElementById(input_id);
                var options = document.getElementById(input_id+"-options");
                input.value = options.value;
                options.style.display = "none";
            }
            function update_submit_name() {
                var id_row = document.getElementById("id");
                var id_input = id_row.getElementsByTagName("input");
                var submit_row = document.getElementById("submit");
                var submit = submit_row.getElementsByTagName("input");

                if (server_state.metadata.includes(id_input[0].value)) {
                    submit[0].value = "Update";
                } else {
                    submit[0].value = "Add";
                }
            }
            function toggle_display(element_id, phase1, phase2) {
                var element = document.getElementById(element_id);

                if (element.style.display != phase1) {
                    element.style.display = phase1;
                } else {
                    element.style.display = phase2;
                }
            }
            function load_person_into(person, parents, spouses, children) {
                var request = new XMLHttpRequest();
                
                request.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var person_info = JSON.parse(request.responseText);

                    }
                }
                request.open("GET", "/api/v1/people/" + person_id, true);
                request.send();
            }
            function load_person(person_element_id) {
                var element = document.getElementById(person_element_id);
                var person = document.getElementById('person_lookup');
                var parents = document.getElementById('parents_lookup');
                var spouses = document.getElementById('spouses_lookup');
                var children = document.getElementById('children_lookup');
                
                person.innerHTML = "";
                parents.innerHTML = "";
                spouses.innerHTML = "";
                children.innerHTML = "";

                if (!server_state.people.includes(element.value)) {
                    return;  // person not found
                }
                load_person_into(person, )
            }

        </script>
    </head>
	<body class="notranslate" onload="load_values();type_change('type')">
        <h1>genweb editor</h1>
        <div class="editor">
            <table>
                <tr>
                    <th colspan=2>
                        <select id="type" onchange="type_change('type')">
                            <option>picture</option>
                            <option>inline</option>
                            <option>href</option>
                        </select>
                    </th>
                </tr>
                <tr id="id">
                    <td class="table_label">Identifier</td>
                    <td>
                        <input placeholder="SurnameNameI0000SurnameNameI0000" size=40 onchange="update_submit_name()"/>
                    </td>
                </tr>
                <tr id="title">
                    <td class="table_label">Title</td>
                    <td><input placeholder="Metadata Title" size="75"/></td>
                </tr>
                <tr id="path">
                    <td class="table_label">Path</td>
                    <td><input placeholder="SurnameNameI0000SurnameNameI0000 (owner)" size="40"/></td>
                </tr>
                <tr id="file">
                    <td class="table_label">File</td>
                    <td><input placeholder="SurnameNameI0000SurnameNameI0000.ext" size="40"/></td>
                </tr>
                <tr id="mod_date">
                    <td class="table_label">Mod Date</td>
                    <td><input type="date"/></td>
                </tr>
                <tr id="people">
                    <td class="table_label">People</td>
                    <td>
                        <textarea style="overflow-y: scroll;" rows="10" cols="40"></textarea>
                        <button onclick="toggle_display('people_search', 'none', 'inline-block')">ðŸ”Ž</button>
                    </td>
                </tr>
                <tr id="folder">
                    <td class="table_label">Folder</td>
                    <td><input placeholder="SubsiteFolder" size="40"/></td>
                </tr>
                <tr id="height">
                    <td class="table_label">Height</td>
                    <td><input type="number" min="20" max="10000"/></td>
                </tr>
                <tr id="width">
                    <td class="table_label">Width</td>
                    <td><input type="number" min="20" max="10000"/></td>
                </tr>
                <tr id="contents">
                    <td class="table_label">Contents</td>
                    <td><textarea placeholder="Inline HTML content" rows="10" cols="120"></textarea></td>
                </tr>
                <tr id="submit">
                    <td></td>
                    <td style="text-align: center;"><input value="Add" type="submit"/></td></td>
                </tr>
            </table>
        </div>
        <div id="people_search">
            <input id="search-person" size=40 placeholder="Search for person id" type="text" onchange="load_person('search-person')" ="type_ahead('search-person', 'people')" onblur="blur_type_ahead('search-person', 'people')"/>
            <br/>
            <select id="search-person-options" style="display:none" size=5 onchange="select_type_ahead('search-person')"></select>
            <ul>
                <li>
                    Person
                    <ul id="person_lookup"></ul>
                </li>
                <li>
                    Parents
                    <ol id="parents_lookup"></ol>
                </li>
                <li>
                    Spouses
                    <ol id="spouses_lookup"></ol>
                </li>
                <li>
                    Children
                    <ol id="children_lookup"></ol>
                </li>
            </ul>
    </div>

        
        <div style="background-color: gray; padding:30px; border-radius:30px">
            <h2>Proof of concept and example code</h2>

            API
            <ul>
                <li><a href="/api/v1/metadata">Metadata</a></li>
                <li><a href ="/api/v1/people">People</a></li>
            </ul>
            <select name="people" id="people"></select>
            <select name="metadata" id="metadata"></select>
            <div style="background-color: beige;border-radius: 15px; padding:30px" width="100">
                <input id="choose-person" size=40 placeholder="Search for person id" type="text" onkeyup="type_ahead('choose-person', 'people')" onblur="blur_type_ahead('choose-person', 'people')"/>
                <br/>
                <select id="choose-person-options" style="display:none" size=5 onchange="select_type_ahead('choose-person')"></select>
            </div>
            <div style="background-color: aliceblue;border-radius: 15px; padding:30px" width="100">
                <input id="choose-metadata" size=40 placeholder="Copy metadata" type="text" onkeyup="type_ahead('choose-metadata', 'metadata')" onblur="blur_type_ahead('choose-metadata', 'metadata')"/>
                <br/>
                <select id="choose-metadata-options" style="display:none" size=5 onchange="select_type_ahead('choose-metadata')"></select>
            </div>
        </div>

    </body>
</html>
