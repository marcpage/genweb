<!DOCTYPE html>
<html lang="en" translate="no" class="notranslate">
	<head>
        <title>genweb editor</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta charset="utf-8"/>
		<meta name="google" content="notraslate"/>
        <style>
            .table_label {
                text-align: right;
                font-weight: bold;
            }

            .editor {
                background-color: azure;
                border-radius: 30px;
                padding: 30px;
                /*display:inline-block;*/
            }

            #people_search {
                display: none; /* inline-block */
                background-color:blanchedalmond;
                border-radius: 30px;
                padding: 30px;
                display: none;
            }
            
        </style>
        <script>
            const MAXIMUM_TYPE_AHEAD = 50;
            var server_state = {people:undefined, metadata:undefined};
            const input_types = ['input', 'select', 'textarea'];
            const visible_fields = {
                title:["inline", "href", "picture"],
                path:["inline", "href", "picture"],
                file:["inline", "href", "picture"],
                people:["inline", "href", "picture"],
                mod_date:["inline", "picture", "href"],
                folder:["href"],
                height:["picture"],
                caption:["picture"],
                width:["picture"],
                contents:["inline"],
            };
            
            function type_change(selector_id) {
                var selector = document.getElementById(selector_id);
                
                for (const field in visible_fields) {
                    var field_row = document.getElementById(field);

                    if (visible_fields[field].includes(selector.value)) {
                        field_row.style.display = "table-row";
                    } else {
                        field_row.style.display = "none";
                    }
                }
            }

            function reset_select(field, values) {
                var select = document.getElementById(field);
                
                while (select.options.length > 0) {
                    select.remove(select.options.length - 1);
                }

                for (var i = 0; i < values.length; ++i) {
                    var option = document.createElement("option");
                    option.value = values[i];
                    option.innerHTML = values[i];
                    select.appendChild(option);
                }
            }

            function load_into(url, field) {
                var request = new XMLHttpRequest();

                request.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        server_state[field] = JSON.parse(request.responseText);
                    }
                }

                request.open("GET", url, true);
                request.send();
            }

            function load_values() {
                load_into("/api/v1/people", "people");
                load_into("/api/v1/metadata", "metadata");
            }

            function words_match(words, value) {
                const word_list = words.split(" ").map((x) => x.toLowerCase());;
                const lower_value = value.toLowerCase();
                const matches = word_list.filter((word) => lower_value.includes(word));

                return matches.length == word_list.length;
            }

            function type_ahead(input_id, field, autoshow) {
                if (server_state[field]) {
                    var input = document.getElementById(input_id);
                    var options = document.getElementById(input_id+"-options");
                    const matches = server_state[field].filter(function (i) {
                        return words_match(input.value, i);
                    }).slice(0,MAXIMUM_TYPE_AHEAD);

                    reset_select(input_id+"-options", [""].concat(matches));

                    if (autoshow) {
                        options.style.display = matches ? "" : "none";
                    }

                    options.size = matches.length + 1;
                }
            }

            function blur_type_ahead(input_id, field, clearOnMismatch) {
                var input = document.getElementById(input_id);
                var options = document.getElementById(input_id+"-options");

                if (clearOnMismatch && !server_state[field].includes(input.value)) {
                    setTimeout(() => { 
                        options.style.display="none";
                        input.value = "";
                }, 400);
            }
        }

            function set_focus(input_id) {
                var input = document.getElementById(input_id);

                input.focus();
            }
            function select_type_ahead(input_id) {
                var input = document.getElementById(input_id);
                var options = document.getElementById(input_id+"-options");

                input.value = options.value;
                options.style.display = "none";
            }

            function load_metadata_into(metadata_identifier) {
                var request = new XMLHttpRequest();
                
                request.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var metadata_info = JSON.parse(request.responseText);
                        var type_selector = document.getElementById("type-selector");

                        for(var field in metadata_info) {
                            var row = document.getElementById(field);
                            var row_input = [];

                            for (var i = 0; i < input_types.length; ++i) {
                                row_input = row.getElementsByTagName(input_types[i]);

                                if (row_input.length > 0) {
                                    break;
                                }
                            }

                            if ( (row_input.length > 0) && field != 'id') {
                                console.log(field + " = " + metadata_info[field]);
                                row_input[0].value = metadata_info[field];
                            } else {
                                console.log("Unknown field: " + field + " = " + metadata_info[field]);
                            }
                        }

                        type_change('type-selector');
                    }
                }

                request.open("GET", "/api/v1/metadata/" + metadata_identifier, true);
                request.send();
            }
            
            function update_submit_name() {
                var id_row = document.getElementById("id");
                var id_input = id_row.getElementsByTagName("input");
                var submit_row = document.getElementById("submit");
                var submit = submit_row.getElementsByTagName("input");

                if (server_state.metadata.includes(id_input[0].value)) {
                    submit[0].value = "Update";
                    load_metadata_into(id_input[0].value);
                } else {
                    submit[0].value = "Add";
                }
            }

            function toggle_display(element_id, phase1, phase2) {
                var element = document.getElementById(element_id);

                if (element.style.display != phase1) {
                    element.style.display = phase1;
                } else {
                    element.style.display = phase2;
                }
            }

            function load_person_into(person_identifier, person, parents, spouses, children) {
                var request = new XMLHttpRequest();
                
                request.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var person_info = JSON.parse(request.responseText);
                        var area = document.createElement("li");

                        area.innerHTML = "<b>" + person_info.id + "</b><br/>" 
                                        + "(" + person_info.gender + ") " + person_info.surname + "," + person_info.given + "<br/>"
                                        + person_info.birthdate + " - " + person_info.deathdate
                        person.appendChild(area);

                        if (parents) {
                            for (var i = 0; i < person_info.parents.length; ++i) {
                                load_person_into(person_info.parents[i], parents, undefined, undefined, undefined);
                            }
                        }

                        if (spouses) {
                            for (var i = 0; i < person_info.spouses.length; ++i) {
                                load_person_into(person_info.spouses[i], spouses, undefined, undefined, undefined);
                            }
                        }

                        if (children) {
                            for (var i = 0; i < person_info.children.length; ++i) {
                                load_person_into(person_info.children[i], children, undefined, undefined, undefined);
                            }
                        }
                    }
                }

                request.open("GET", "/api/v1/people/" + person_identifier, true);
                request.send();
            }
            
            function load_person(person_element_id) {
                var element = document.getElementById(person_element_id);
                var person = document.getElementById('person_lookup');
                var parents = document.getElementById('parents_lookup');
                var spouses = document.getElementById('spouses_lookup');
                var children = document.getElementById('children_lookup');
                
                person.innerHTML = "";
                parents.innerHTML = "";
                spouses.innerHTML = "";
                children.innerHTML = "";

                if (!server_state.people.includes(element.value)) {
                    return;  // person not found
                }

                load_person_into(element.value, person, parents, spouses, children);
            }

        </script>
    </head>
	<body class="notranslate" onload="load_values();type_change('type-selector')">
        <h1>genweb editor</h1>
        <div class="editor">
            <table>
                <tr id="type">
                    <th colspan=2>
                        <select id="type-selector" onchange="type_change('type-selector')">
                            <option>picture</option>
                            <option>inline</option>
                            <option>href</option>
                        </select>
                    </th>
                </tr>
                <tr id="id">
                    <td class="table_label">Identifier</td>
                    <td>
                        <input id="choose-metadata" placeholder="SurnameNameI0000SurnameNameI0000" size=40 onchange="update_submit_name()" onkeyup="type_ahead('choose-metadata', 'metadata', false)" onblur="blur_type_ahead('choose-metadata', 'metadata', false)"/>
                        <button onclick="toggle_display('choose-metadata-options', '', 'none');type_ahead('choose-metadata', 'metadata', false);set_focus('choose-metadata')">🔎</button>
                        <br/>
                        <select id="choose-metadata-options" style="display:none" size=5 onchange="select_type_ahead('choose-metadata');update_submit_name()"></select>
                    </td>
                </tr>
                <tr id="title">
                    <td class="table_label">Title</td>
                    <td><input placeholder="Metadata Title" size="75"/></td>
                </tr>
                <tr id="path">
                    <td class="table_label">Path</td>
                    <td><input placeholder="SurnameNameI0000SurnameNameI0000 (owner)" size="40"/></td>
                </tr>
                <tr id="file">
                    <td class="table_label">File</td>
                    <td><input placeholder="SurnameNameI0000SurnameNameI0000.ext" size="50"/></td>
                </tr>
                <tr id="mod_date">
                    <td class="table_label">Mod Date</td>
                    <td><input type="date"/></td>
                </tr>
                <tr id="people">
                    <td class="table_label">People</td>
                    <td>
                        <textarea style="overflow-y: scroll;" rows="10" cols="40"></textarea>
                        <button onclick="toggle_display('people_search', 'block', 'none')">🔎</button>
                    </td>
                </tr>
                <tr id="caption">
                    <td class="table_label">Caption</td>
                    <td><input placeholder="Metadata Caption" size="75"/></td>
                </tr>
                <tr id="folder">
                    <td class="table_label">Folder</td>
                    <td><input placeholder="SubsiteFolder" size="40"/></td>
                </tr>
                <tr id="height">
                    <td class="table_label">Height</td>
                    <td><input type="number" min="20" max="10000"/></td>
                </tr>
                <tr id="width">
                    <td class="table_label">Width</td>
                    <td><input type="number" min="20" max="10000"/></td>
                </tr>
                <tr id="contents">
                    <td class="table_label">Contents</td>
                    <td><textarea placeholder="Inline HTML content" rows="10" cols="120"></textarea></td>
                </tr>
                <tr id="submit">
                    <td></td>
                    <td style="text-align: center;"><input value="Add" type="submit"/></td></td>
                </tr>
            </table>
        </div>
        <div id="people_search">
            <input id="search-person" size=40 placeholder="Search for person id" type="text" onkeyup="type_ahead('search-person', 'people', true)" onblur="blur_type_ahead('search-person', 'people', true)"/>
            <br/>
            <select id="search-person-options" style="display:none" size=5 onchange="load_person('search-person-options')"></select>
            <ul>
                <li>
                    Person
                    <ul id="person_lookup"></ul>
                </li>
                <li>
                    Parents
                    <ol id="parents_lookup"></ol>
                </li>
                <li>
                    Spouses
                    <ol id="spouses_lookup"></ol>
                </li>
                <li>
                    Children
                    <ol id="children_lookup"></ol>
                </li>
            </ul>
    </div>

        
    </body>
</html>
